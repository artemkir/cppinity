# Collect engine sources/headers
file(GLOB_RECURSE ENGINE_SOURCES CONFIGURE_DEPENDS src/*.cpp src/*.c)
file(GLOB_RECURSE ENGINE_HEADERS CONFIGURE_DEPENDS include/*.h)

add_library(Engine STATIC ${ENGINE_SOURCES} ${ENGINE_HEADERS})

# Auto-generate umbrella header: Engine.h
set(ENGINE_INCLUDE_DIR "${CMAKE_CURRENT_SOURCE_DIR}/include")
set(GENERATED_INCLUDE_DIR "${CMAKE_CURRENT_BINARY_DIR}/generated")
file(MAKE_DIRECTORY "${GENERATED_INCLUDE_DIR}")

# Collect all public headers under include/, but exclude third-party folders like stb/
file(GLOB_RECURSE ENGINE_PUBLIC_HEADERS CONFIGURE_DEPENDS
    "${ENGINE_INCLUDE_DIR}/*.h"
)
list(FILTER ENGINE_PUBLIC_HEADERS EXCLUDE REGEX "/stb/")

# Make relative to include/ and sort for stable output
set(ENGINE_PUBLIC_HEADERS_REL)
foreach(h ${ENGINE_PUBLIC_HEADERS})
    file(RELATIVE_PATH rel "${ENGINE_INCLUDE_DIR}" "${h}")
    list(APPEND ENGINE_PUBLIC_HEADERS_REL "${rel}")
endforeach()
list(SORT ENGINE_PUBLIC_HEADERS_REL)

# Write Engine.h
set(ENGINE_UMBRELLA "${GENERATED_INCLUDE_DIR}/Engine.h")
set(_content "// Auto-generated by CMake. Do not edit.\n#pragma once\n\n")
foreach(rel ${ENGINE_PUBLIC_HEADERS_REL})
    string(APPEND _content "#include \"${rel}\"\n")
endforeach()
file(WRITE "${ENGINE_UMBRELLA}" "${_content}")

# Make generated header visible to dependents
target_include_directories(Engine
    PUBLIC
        "${ENGINE_INCLUDE_DIR}"          # your real headers
        "${GENERATED_INCLUDE_DIR}"       # exposes Engine.h
        "${sokol_SOURCE_DIR}"
	    "oryol/Modules"
)

# Link platform/system deps once here
target_link_libraries(Engine PUBLIC platform_deps)